<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <style>
        body {
            margin: 0;
            background: #0b0b0b;
            color: #fff;
            font-family: Arial, "Microsoft YaHei", sans-serif;
        }

        /* ========== 登录区（右上角） ========== */
        .login-box {
            position: fixed;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 10px;
            background: #121212;
            border: 1px solid rgba(255,255,255,.15);
            border-radius: 12px;
            z-index: 30;
        }

        .login-box input {
            width: 80px;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,.25);
            background: rgba(255,255,255,.05);
            color: #fff;
            font-size: 12px;
        }

        .login-box button {
            padding: 6px 10px;
            border-radius: 8px;
            border: none;
            font-weight: 800;
            cursor: pointer;
            font-size: 12px;
        }

        .login-btn { background: #fff; color: #111; }
        .logout-btn { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.3); }
        .login-state { font-size: 12px; opacity: .8; }

        /* ========== 玩家信息（左上角） ========== */
        .player-info {
            position: fixed;
            top: 12px;
            left: 12px;
            padding: 10px 14px;
            background: #121212;
            border: 1px solid rgba(255,255,255,.15);
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.6;
            z-index: 20;
        }

        /* ========== 技能商店按钮（左下角） ========== */
        .shop-toggle {
            position: fixed;
            bottom: 12px;
            left: 12px;
            z-index: 10;
        }

        button.primary {
            background: #fff;
            color: #111;
            font-weight: 800;
        }

        button.disabled {
            background: #555;
            color: #aaa;
            cursor: not-allowed;
        }

        /* ========== 技能商店面板 ========== */
        .shop-panel {
            position: fixed;
            left: 12px;
            bottom: 64px;
            width: 520px;
            max-height: 60vh;
            overflow-y: auto;
            background: #121212;
            border: 1px solid rgba(255,255,255,.15);
            border-radius: 14px;
            padding: 12px;
            display: none;
            z-index: 10;
        }

        .skill-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 10px;
            border: 1px solid rgba(255,255,255,.12);
            border-radius: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,.04);
        }

        .skill-info {
            font-size: 13px;
            line-height: 1.5;
        }

        .skill-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }

        select {
            padding: 6px;
            border-radius: 8px;
        }

        /* ========== 装备槽 ========== */
        .slots {
            position: fixed;
            bottom: 12px;
            left: 160px;
            display: none;
            gap: 10px;
            z-index: 10;
        }

        .slot {
            min-width: 110px;
            padding: 8px;
            background: #121212;
            border: 1px solid rgba(255,255,255,.15);
            border-radius: 10px;
            text-align: center;
            font-size: 13px;
        }

        /* ========== 战斗列表 ========== */
        .enemy-toggle {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 8px;
            background: #fff;
            color: #111;
            border-radius: 10px 0 0 10px;
            font-weight: 800;
            cursor: pointer;
            z-index: 15;
        }

        .enemy-panel {
            position: fixed;
            top: 72px;
            right: 0;
            width: 25vw;
            max-width: 360px;
            height: calc(100vh - 84px);
            background: #121212;
            border-left: 1px solid rgba(255,255,255,.15);
            padding: 12px;
            display: none;
            overflow-y: auto;
            z-index: 14;
        }

        .enemy-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid rgba(255,255,255,.12);
            border-radius: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,.04);
        }
    </style>

    <!-- ===== 仅新增：战斗界面样式（不改原样式） ===== -->
    <style>
        .fight-view{
            position:fixed; inset:0;
            background:#0b0b0b;
            display:none;
            z-index:60;
        }
        .fight-player, .fight-enemy{
            position:fixed;
            top:12px;
            padding:10px 14px;
            background:#121212;
            border:1px solid rgba(255,255,255,.15);
            border-radius:12px;
            font-size:13px;
            line-height:1.6;
        }
        .fight-player{ left:12px; }
        .fight-enemy{ right:12px; }

        /* 右上角退出按钮：避开登录盒子（你要求“上面要空出登录模块”） */
        .fight-exit{
            position:fixed;
            top:88px;
            right:12px;
            z-index:61;
        }

        .fight-slots{
            position:fixed;
            left:50%;
            transform:translateX(-50%);
            bottom:150px; /* 比 log 高一个“装备槽高度” */
            display:flex;
            gap:8px;
            z-index:61;
        }
        .fight-slot{
            min-width:92px;
            padding:6px 8px;
            background:#121212;
            border:1px solid rgba(255,255,255,.15);
            border-radius:8px;
            text-align:center;
            font-size:12px;
            opacity:.95;
        }

        .fight-log{
            position:fixed;
            left:50%;
            transform:translateX(-50%);
            bottom:60px;
            width:60%;
            height:78px;
            background:#121212;
            border:1px solid rgba(255,255,255,.15);
            border-radius:12px;
            padding:10px;
            font-size:12px;
            opacity:.65;
            z-index:61;
        }

        .fight-bag{
            position:fixed;
            right:12px;
            bottom:60px; /* 与 log 持平 */
            z-index:61;
        }
    </style>
</head>
<body>

<!-- 登录 -->
<div class="login-box">
    <input id="pid" placeholder="ID">
    <input id="pname" placeholder="名称">
    <button class="login-btn" id="loginBtn">登录</button>
    <button class="logout-btn" id="logoutBtn">退出</button>
    <span class="login-state" id="loginState">未登录</span>
</div>

<div class="player-info" id="playerInfo">未登录</div>

<div class="shop-toggle">
    <button class="primary" id="toggleShopBtn">技能商店</button>
</div>

<div class="shop-panel" id="shopPanel"></div>
<div class="slots" id="slots"></div>

<div class="enemy-toggle" id="toggleEnemyBtn">战斗列表</div>
<div class="enemy-panel" id="enemyPanel"></div>

<!-- ===== 仅新增：战斗界面 DOM（不影响原页面） ===== -->
<div class="fight-view" id="fightView">
    <div class="fight-player" id="fightPlayer">玩家信息</div>
    <div class="fight-enemy" id="fightEnemy">敌人信息</div>

    <div class="fight-exit">
        <button class="primary" id="exitFightBtn">退出战斗</button>
    </div>

    <div class="fight-slots" id="fightSlots"></div>
    <div class="fight-log" id="fightLog"></div>

    <div class="fight-bag">
        <button class="logout-btn" id="bagBtn">背包</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    const API = {
        register: "/register",
        shop: "/skillshop",
        learn: "/learnskill",
        equip: "/equipskill",
        enemies: "/enemylist"
    };

    let player = JSON.parse(localStorage.getItem("player"));
    let skillNameMap = {};
    const el = id => document.getElementById(id);

    function renderLoginState() {
        el("loginState").textContent = player ? "已登录" : "未登录";
    }

    function renderPlayer() {
        el("playerInfo").innerHTML = player
            ? `ID:${player.id}<br>名字:${player.name}<br>等级:${player.lv}<br>金钱:${player.money}`
            : "未登录";
    }

    function renderSlots() {
        const box = el("slots");
        box.innerHTML = "";
        player.playerSkill.slots.forEach(s =>
            box.innerHTML += `<div class="slot">${s ? (skillNameMap[s] || s) : "空"}</div>`
        );
    }

    async function openShop() {
        const res = await axios.get(API.shop);
        const owned = new Set(player.playerSkill.owned);
        const panel = el("shopPanel");
        panel.innerHTML = "";
        skillNameMap = {};

        res.data.forEach(s => {
            skillNameMap[s.id] = s.name;
            const learned = owned.has(s.id);

            const row = document.createElement("div");
            row.className = "skill-row";
            row.innerHTML = `
            <div class="skill-info">
                <b>${s.name}</b><br>
                等级限制:${s.lvLimited}<br>
                金钱:${s.moneyCost}<br>
                伤害:${s.hp}<br>
                蓝耗:${s.mpCost}
            </div>
            <div class="skill-actions">
                <button class="${learned ? "disabled" : "primary"}" ${learned ? "disabled" : ""}>${learned ? "已学习" : "学习"}</button>
                <select>
                    <option value="">槽位</option>
                    <option>1</option><option>2</option><option>3</option>
                    <option>4</option><option>5</option>
                </select>
                <button class="primary disabled">装备</button>
            </div>
        `;

            const [learnBtn, select, equipBtn] = row.querySelectorAll("button,select");

            if (!learned) {
                learnBtn.onclick = async () => {
                    const r = await axios.post(API.learn, { playerId: player.id, skillId: s.id });
                    player = r.data;
                    localStorage.setItem("player", JSON.stringify(player));
                    openShop(); renderPlayer(); renderSlots();
                };
            }

            select.onchange = () =>
                equipBtn.classList.toggle("disabled", !owned.has(s.id) || !select.value);

            equipBtn.onclick = async () => {
                if (equipBtn.classList.contains("disabled")) return;
                const r = await axios.post(API.equip, { playerId: player.id, skillId: s.id, index: Number(select.value) });
                player = r.data;
                localStorage.setItem("player", JSON.stringify(player));
                renderSlots();
            };

            panel.appendChild(row);
        });
    }

    el("toggleShopBtn").onclick = async () => {
        if (!player) return;
        const show = el("shopPanel").style.display !== "block";
        el("shopPanel").style.display = show ? "block" : "none";
        el("slots").style.display = show ? "flex" : "none";
        if (show) await openShop();
    };

    el("toggleEnemyBtn").onclick = async () => {
        const panel = el("enemyPanel");
        panel.style.display = panel.style.display === "block" ? "none" : "block";
        if (panel.style.display === "block") {
            const res = await axios.get(API.enemies);
            panel.innerHTML = res.data.map(e =>
                `<div class="enemy-row">${e.name} Lv.${e.lv}<button class="disabled">战斗</button></div>`
            ).join("");
        }
    };

    el("loginBtn").onclick = async () => {
        const id = Number(el("pid").value.trim());
        const name = el("pname").value.trim();
        if (!Number.isInteger(id) || !name) return;
        const res = await axios.post(API.register, { id, name });
        player = res.data;
        localStorage.setItem("player", JSON.stringify(player));
        renderPlayer(); renderLoginState();
    };

    el("logoutBtn").onclick = () => {
        localStorage.removeItem("player");
        player = null;
        renderPlayer(); renderLoginState();
        el("shopPanel").style.display = "none";
        el("slots").style.display = "none";
    };

    renderPlayer();
    renderLoginState();
    if (player) renderSlots();
</script>

<!-- ===== 仅新增：战斗功能脚本（不改原脚本） ===== -->
<script>
    // 新增 API
    API.fight = "/fight";

    let enemiesCache = []; // 保存 enemylist，用于战斗界面展示 maxHP/lv/id

    function showFightUI(fight, enemy){
        // 左上：玩家 id lv curhp/hp curmp/mp
        el("fightPlayer").innerHTML =
            `玩家ID:${player.id}<br>` +
            `Lv:${player.lv}<br>` +
            `HP:${fight.curPlayerHp} / ${player.hp}<br>` +
            `MP:${fight.curPlayerMp} / ${player.mp}`;

        // 右上：敌人 id lv curhp/hp
        el("fightEnemy").innerHTML =
            `敌人ID:${enemy.id}<br>` +
            `Lv:${enemy.lv}<br>` +
            `HP:${fight.curEnemyHp} / ${enemy.hp}`;

        // 中下：装备槽按钮（小一点，不绑定事件，显示技能名）
        const slots = (player && player.playerSkill && Array.isArray(player.playerSkill.slots))
            ? player.playerSkill.slots : [];

        el("fightSlots").innerHTML = slots.map(sid => {
            const name = sid ? (skillNameMap[sid] || sid) : "空";
            return `<div class="fight-slot">${name}</div>`;
        }).join("");

        // Log 区域：先空白占位
        el("fightLog").textContent = "";

        // 退出按钮：curEnemyHp != 0 时禁用（你要求）
        el("exitFightBtn").disabled = (fight.curEnemyHp !== 0);

        // 显示战斗页面
        el("fightView").style.display = "block";
    }

    // 退出战斗按钮：只有可点击时才关闭
    el("exitFightBtn").addEventListener("click", () => {
        if (el("exitFightBtn").disabled) return;
        el("fightView").style.display = "none";
    });

    // 背包按钮：不绑定事件（按你要求）——这里只是不做任何事
    // el("bagBtn").addEventListener("click", ()=>{});

    // 关键：你原来 enemyPanel 里“战斗按钮”是 disabled + 没有 enemyId 信息
    // 所以我们在不改原代码的前提下：覆盖 toggleEnemyBtn 的 onclick（运行时覆盖）
    const oldToggleEnemy = el("toggleEnemyBtn").onclick;

    el("toggleEnemyBtn").onclick = async () => {
        const panel = el("enemyPanel");
        panel.style.display = panel.style.display === "block" ? "none" : "block";

        if (panel.style.display === "block") {
            const res = await axios.get(API.enemies);
            enemiesCache = res.data || [];

            // 重新渲染：加上 enemyId，按钮可点
            panel.innerHTML = enemiesCache.map(e =>
                `<div class="enemy-row">
                    ${e.name} Lv.${e.lv}
                    <button class="primary" data-enemy-id="${e.id}">战斗</button>
                 </div>`
            ).join("");
        }
    };

    // 事件委托：点击 enemyPanel 内的“战斗”
    el("enemyPanel").addEventListener("click", async (ev) => {
        const btn = ev.target;
        if (!(btn instanceof HTMLButtonElement)) return;
        const enemyId = btn.getAttribute("data-enemy-id");
        if (!enemyId) return;

        if (!player) return; // 未登录直接不做

        // 找到对应 enemy 数据（用于 max hp / lv 展示）
        const enemy = enemiesCache.find(x => x.id === enemyId) || {id: enemyId, lv: 0, hp: 0};

        try{
            const fightRes = await axios.post(API.fight, { playerId: player.id, enemyId: enemyId });
            showFightUI(fightRes.data, enemy);
        }catch(e){
            // 最小化处理：不改你原页面，只是 console 打印一下
            console.error(e);
        }
    });
</script>

</body>
</html>
